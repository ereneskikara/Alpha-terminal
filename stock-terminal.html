<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="AlphaTerminal"/>
<title>AlphaTerminal</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #080c10; --bg2: #0d1117; --bg3: #111820;
  --border: #1e2d3d; --accent: #00d4ff; --accent2: #00ff88;
  --warn: #ffaa00; --danger: #ff3b5c;
  --text: #e8f4f8; --text2: #7a9bb5; --text3: #3d5a70;
  --green: #00e676; --red: #ff3b5c; --gold: #ffd700;
  --card: rgba(13,17,23,0.95);
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body { height:100%; background:var(--bg); color:var(--text); font-family:'Syne',sans-serif; overflow:hidden; }
body::before {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  opacity:0.4;
}
body::after {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 40px,rgba(0,212,255,0.015) 40px,rgba(0,212,255,0.015) 41px);
}
#app { position:relative; z-index:1; height:100dvh; display:flex; flex-direction:column; padding-top:env(safe-area-inset-top); }
header {
  padding:12px 16px 10px; display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid var(--border); background:rgba(8,12,16,0.98); backdrop-filter:blur(20px); flex-shrink:0;
}
.logo { font-family:'Space Mono',monospace; font-size:14px; color:var(--accent); letter-spacing:2px; }
.logo span { color:var(--accent2); }
.header-right { display:flex; gap:10px; align-items:center; }
.live-dot { width:7px; height:7px; border-radius:50%; background:var(--green); animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,230,118,0.4)} 50%{opacity:0.7;box-shadow:0 0 0 6px rgba(0,230,118,0)} }
.time-display { font-family:'Space Mono',monospace; font-size:10px; color:var(--text2); }
nav { display:flex; border-bottom:1px solid var(--border); background:var(--bg2); overflow-x:auto; scrollbar-width:none; flex-shrink:0; }
nav::-webkit-scrollbar { display:none; }
.tab { padding:10px 16px; font-size:11px; font-weight:700; letter-spacing:1px; color:var(--text3); white-space:nowrap; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; text-transform:uppercase; }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }
main { flex:1; overflow-y:auto; overflow-x:hidden; padding:12px; padding-bottom:80px; }
main::-webkit-scrollbar { width:3px; }
main::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
.card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:12px; position:relative; overflow:hidden; }
.card::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,var(--accent),transparent); opacity:0.3; }
.card-title { font-size:10px; font-weight:700; letter-spacing:2px; color:var(--text3); text-transform:uppercase; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.watchlist-item { display:flex; align-items:center; justify-content:space-between; padding:10px 8px; border-bottom:1px solid rgba(30,45,61,0.5); cursor:pointer; transition:background 0.2s; border-radius:8px; }
.watchlist-item:hover { background:rgba(0,212,255,0.05); }
.watchlist-item:last-child { border-bottom:none; }
.ticker-symbol { font-family:'Space Mono',monospace; font-size:14px; font-weight:700; }
.ticker-name { font-size:10px; color:var(--text3); }
.ticker-price { font-family:'Space Mono',monospace; font-size:14px; font-weight:700; }
.ticker-change { font-family:'Space Mono',monospace; font-size:10px; padding:2px 6px; border-radius:4px; }
.up { color:var(--green); } .down { color:var(--red); }
.bg-up { background:rgba(0,230,118,0.1); color:var(--green); }
.bg-down { background:rgba(255,59,92,0.1); color:var(--red); }
.signal-badge { font-size:9px; font-weight:700; letter-spacing:1px; padding:3px 7px; border-radius:4px; text-transform:uppercase; }
.signal-buy { background:rgba(0,230,118,0.15); color:var(--green); border:1px solid rgba(0,230,118,0.3); }
.signal-sell { background:rgba(255,59,92,0.15); color:var(--red); border:1px solid rgba(255,59,92,0.3); }
.signal-hold { background:rgba(255,170,0,0.15); color:var(--warn); border:1px solid rgba(255,170,0,0.3); }
.add-stock-btn { display:flex; align-items:center; gap:8px; padding:10px 14px; background:rgba(0,212,255,0.05); border:1px dashed rgba(0,212,255,0.3); border-radius:10px; cursor:pointer; color:var(--accent); font-size:12px; font-weight:700; letter-spacing:1px; transition:all 0.2s; margin-top:8px; }
canvas.minichart { width:100%; height:80px; display:block; border-radius:8px; }
.indicators-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.indicator-item { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:8px; padding:10px; }
.ind-label { font-size:9px; color:var(--text3); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
.ind-value { font-family:'Space Mono',monospace; font-size:16px; font-weight:700; }
.ind-status { font-size:9px; margin-top:2px; }
.signal-main { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
.signal-action { font-size:28px; font-weight:800; letter-spacing:-1px; }
.confidence-wrap { text-align:right; }
.confidence-score { font-family:'Space Mono',monospace; font-size:24px; font-weight:700; color:var(--accent); }
.confidence-label { font-size:9px; color:var(--text3); letter-spacing:1px; text-transform:uppercase; }
.signal-reasons { display:flex; flex-direction:column; gap:6px; }
.reason-item { display:flex; align-items:center; gap:8px; font-size:11px; color:var(--text2); padding:6px 10px; background:rgba(255,255,255,0.02); border-radius:6px; }
.reason-bull { border-left:2px solid var(--green); }
.reason-bear { border-left:2px solid var(--red); }
.reason-neutral { border-left:2px solid var(--warn); }
.progress-bar { height:4px; background:var(--bg3); border-radius:2px; overflow:hidden; margin-top:6px; }
.progress-fill { height:100%; border-radius:2px; transition:width 0.5s ease; }
.fib-table { width:100%; border-collapse:collapse; }
.fib-table td { padding:6px 8px; font-family:'Space Mono',monospace; font-size:11px; border-bottom:1px solid rgba(30,45,61,0.4); }
.fib-table td:first-child { color:var(--text3); }
.fib-table td:last-child { text-align:right; font-weight:700; }
.fib-key { color:var(--gold) !important; }
.opp-card { background:linear-gradient(135deg,rgba(255,215,0,0.05),rgba(0,212,255,0.05)); border:1px solid rgba(255,215,0,0.2); border-radius:10px; padding:12px; margin-bottom:8px; cursor:pointer; transition:all 0.2s; }
.opp-card:hover { border-color:rgba(255,215,0,0.4); transform:translateY(-1px); }
.opp-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.opp-ticker { font-family:'Space Mono',monospace; font-size:16px; font-weight:700; color:var(--gold); }
.opp-upside { font-family:'Space Mono',monospace; font-size:12px; color:var(--green); }
.opp-reason { font-size:11px; color:var(--text2); line-height:1.5; }
.opp-tags { display:flex; gap:4px; flex-wrap:wrap; margin-top:8px; }
.opp-tag { font-size:9px; padding:2px 7px; border-radius:3px; font-weight:700; letter-spacing:1px; background:rgba(0,212,255,0.1); color:var(--accent); border:1px solid rgba(0,212,255,0.2); }
.unusual-item { display:flex; flex-direction:column; gap:4px; padding:10px 0; border-bottom:1px solid rgba(30,45,61,0.5); }
.unusual-item:last-child { border-bottom:none; }
.unusual-header { display:flex; justify-content:space-between; align-items:center; }
.unusual-ticker { font-family:'Space Mono',monospace; font-size:13px; font-weight:700; }
.unusual-type { font-size:9px; font-weight:700; padding:2px 7px; border-radius:3px; letter-spacing:1px; }
.call-type { background:rgba(0,230,118,0.15); color:var(--green); }
.put-type { background:rgba(255,59,92,0.15); color:var(--red); }
.unusual-detail { font-family:'Space Mono',monospace; font-size:10px; color:var(--text2); }
.unusual-size { font-size:11px; color:var(--warn); font-weight:700; }
.news-item { padding:10px 0; border-bottom:1px solid rgba(30,45,61,0.5); cursor:pointer; }
.news-item:last-child { border-bottom:none; }
.news-header { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:4px; }
.news-title { font-size:12px; color:var(--text); line-height:1.4; font-weight:600; }
.news-impact { font-size:9px; font-weight:700; padding:2px 6px; border-radius:3px; white-space:nowrap; }
.impact-high { background:rgba(255,59,92,0.15); color:var(--red); }
.impact-med { background:rgba(255,170,0,0.15); color:var(--warn); }
.impact-low { background:rgba(122,155,181,0.15); color:var(--text2); }
.news-meta { font-size:10px; color:var(--text3); }
.sent-bull { color:var(--green); } .sent-bear { color:var(--red); }
/* BOARD CARD â€” FIX: was missing */
.board-item { display:flex; gap:12px; padding:10px 0; border-bottom:1px solid rgba(30,45,61,0.5); }
.board-item:last-child { border-bottom:none; }
.board-avatar { width:38px; height:38px; border-radius:50%; flex-shrink:0; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:800; color:var(--bg); }
.board-info { flex:1; }
.board-name { font-size:13px; font-weight:700; margin-bottom:2px; }
.board-role { font-size:10px; color:var(--accent); margin-bottom:4px; }
.board-bio { font-size:10px; color:var(--text2); line-height:1.4; }
.board-score { font-family:'Space Mono',monospace; font-size:12px; color:var(--gold); font-weight:700; }
.val-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.val-item { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:8px; padding:10px; }
.val-label { font-size:9px; color:var(--text3); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
.val-value { font-family:'Space Mono',monospace; font-size:18px; font-weight:700; }
.val-status { font-size:9px; margin-top:2px; }
.ai-box { background:linear-gradient(135deg,rgba(0,212,255,0.05),rgba(0,255,136,0.03)); border:1px solid rgba(0,212,255,0.2); border-radius:10px; padding:14px; }
.ai-header { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
.ai-label { font-size:10px; font-weight:700; letter-spacing:2px; color:var(--accent); text-transform:uppercase; }
.ai-dot { width:5px; height:5px; border-radius:50%; background:var(--accent); animation:blink 1.4s infinite; }
.ai-dot:nth-child(2){animation-delay:0.2s} .ai-dot:nth-child(3){animation-delay:0.4s}
@keyframes blink { 0%,80%,100%{opacity:0} 40%{opacity:1} }
.ai-text { font-size:12px; color:var(--text2); line-height:1.7; }
.bottom-nav { position:fixed; bottom:0; left:0; right:0; z-index:100; background:rgba(8,12,16,0.98); backdrop-filter:blur(20px); border-top:1px solid var(--border); display:flex; padding-bottom:env(safe-area-inset-bottom); }
.bnav-item { flex:1; display:flex; flex-direction:column; align-items:center; gap:3px; padding:10px 0; cursor:pointer; transition:all 0.2s; color:var(--text3); font-size:9px; font-weight:700; letter-spacing:1px; }
.bnav-item.active { color:var(--accent); }
.bnav-icon { font-size:20px; line-height:1; }
.modal-overlay { position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); display:flex; align-items:flex-end; opacity:0; pointer-events:none; transition:opacity 0.3s; }
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal { background:var(--bg2); border:1px solid var(--border); border-radius:20px 20px 0 0; padding:20px; width:100%; max-height:85vh; overflow-y:auto; transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.4,0,0.2,1); }
.modal-overlay.open .modal { transform:translateY(0); }
.modal-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:0 auto 16px; }
.modal-title { font-size:18px; font-weight:800; margin-bottom:16px; }
input.stock-input { flex:1; background:var(--bg3); border:1px solid var(--border); border-radius:10px; padding:12px 14px; color:var(--text); font-family:'Space Mono',monospace; font-size:14px; outline:none; text-transform:uppercase; }
input.stock-input:focus { border-color:var(--accent); box-shadow:0 0 0 2px rgba(0,212,255,0.1); }
input.stock-input::placeholder { color:var(--text3); text-transform:none; }
.btn-primary { background:var(--accent); color:var(--bg); border:none; border-radius:10px; padding:12px 20px; font-family:'Syne',sans-serif; font-size:13px; font-weight:800; cursor:pointer; letter-spacing:1px; white-space:nowrap; width:100%; margin-top:10px; }
.btn-primary:active { transform:scale(0.97); }
.section-divider { font-size:10px; font-weight:700; letter-spacing:3px; color:var(--text3); text-transform:uppercase; margin:16px 0 8px; padding-left:4px; }
.jackpot-banner { background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(255,100,0,0.05)); border:1px solid rgba(255,215,0,0.3); border-radius:12px; padding:16px; margin-bottom:12px; text-align:center; }
.jackpot-emoji { font-size:32px; margin-bottom:8px; }
.jackpot-title { font-size:16px; font-weight:800; color:var(--gold); margin-bottom:4px; }
.jackpot-sub { font-size:11px; color:var(--text2); }
.exch-btn { padding:5px 12px; border-radius:20px; font-size:10px; font-weight:700; white-space:nowrap; cursor:pointer; transition:all 0.2s; border:1px solid var(--border); color:var(--text3); background:var(--bg3); letter-spacing:0.5px; }
.exch-btn.active { background:rgba(0,212,255,0.15); color:var(--accent); border-color:rgba(0,212,255,0.4); }
.search-result-item { display:flex; align-items:center; justify-content:space-between; padding:10px; border-radius:10px; cursor:pointer; transition:background 0.15s; margin-bottom:4px; border:1px solid transparent; }
.search-result-item:hover { background:rgba(0,212,255,0.07); border-color:rgba(0,212,255,0.15); }
.sri-left { display:flex; align-items:center; gap:10px; flex:1; min-width:0; }
.sri-flag { font-size:18px; line-height:1; flex-shrink:0; }
.sri-info { flex:1; min-width:0; }
.sri-ticker { font-family:'Space Mono',monospace; font-size:13px; font-weight:700; color:var(--text); }
.sri-name { font-size:11px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px; }
.sri-exchange { font-size:9px; color:var(--text3); margin-top:1px; }
.sri-add-btn { font-size:9px; font-weight:700; padding:3px 9px; border-radius:5px; letter-spacing:1px; background:rgba(0,212,255,0.1); color:var(--accent); border:1px solid rgba(0,212,255,0.3); cursor:pointer; }
.sri-add-btn.added { background:rgba(0,230,118,0.1); color:var(--green); border-color:rgba(0,230,118,0.3); }
.wl-chip { display:flex; align-items:center; gap:5px; padding:5px 10px; background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:20px; font-size:11px; font-family:'Space Mono',monospace; color:var(--text2); cursor:pointer; }
.wl-chip .remove { color:var(--red); font-size:13px; line-height:1; }
.skeleton { background:linear-gradient(90deg,var(--bg3) 25%,rgba(255,255,255,0.03) 50%,var(--bg3) 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:6px; height:24px; }
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
.view { display:none; }
.view.active { display:block; }
/* ICHIMOKU */
.ichi-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-top:8px; }
.ichi-item { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:8px; padding:8px; text-align:center; }
.ichi-label { font-size:8px; color:var(--text3); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
.ichi-val { font-family:'Space Mono',monospace; font-size:11px; font-weight:700; }
/* MICRO CAP */
.micro-badge { display:inline-block; font-size:8px; font-weight:700; padding:2px 6px; border-radius:3px; letter-spacing:1px; background:rgba(255,215,0,0.15); color:var(--gold); border:1px solid rgba(255,215,0,0.3); margin-left:6px; }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo">ALPHA<span>TERMINAL</span></div>
    <div class="header-right">
      <div class="live-dot"></div>
      <div class="time-display" id="clock">--:--:--</div>
    </div>
  </header>

  <nav>
    <div class="tab active" data-view="watchlist">ğŸ“Š Ä°zleme</div>
    <div class="tab" data-view="signal">âš¡ Sinyal</div>
    <div class="tab" data-view="opportunities">ğŸ¯ FÄ±rsatlar</div>
    <div class="tab" data-view="unusual">ğŸ”¥ Unusual</div>
    <div class="tab" data-view="news">ğŸŒ Jeopolitik</div>
    <div class="tab" data-view="board">ğŸ‘” YÃ¶netim</div>
    <div class="tab" data-view="valuation">ğŸ’° DeÄŸerleme</div>
    <div class="tab" data-view="microcap">ğŸ’ MicroCap</div>
  </nav>

  <main>

    <!-- WATCHLIST -->
    <div class="view active" id="view-watchlist">
      <div class="card">
        <div class="card-title"><span>ğŸ“ˆ</span>PortfÃ¶y Ä°zleme Listesi</div>
        <div id="watchlistItems"></div>
        <div class="add-stock-btn" id="addStockBtn">+ Hisse Ekle</div>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸ“‰</span>Mini Grafik â€” SeÃ§ili Hisse</div>
        <canvas class="minichart" id="miniChart"></canvas>
        <div style="text-align:center;margin-top:8px;font-size:10px;color:var(--text3)" id="chartLabel">Bir hisse seÃ§in</div>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸŒ¡ï¸</span>Piyasa Ã–zeti</div>
        <div class="indicators-grid">
          <div class="indicator-item"><div class="ind-label">S&P 500</div><div class="ind-value up" id="sp500val">â€”</div><div class="ind-status up" id="sp500chg">YÃ¼kleniyor...</div></div>
          <div class="indicator-item"><div class="ind-label">VIX</div><div class="ind-value" style="color:var(--warn)" id="vixval">â€”</div><div class="ind-status" style="color:var(--warn)" id="vixlbl">â€”</div></div>
          <div class="indicator-item"><div class="ind-label">DXY (Dolar)</div><div class="ind-value down" id="dxyval">â€”</div><div class="ind-status down" id="dxychg">â€”</div></div>
          <div class="indicator-item"><div class="ind-label">10Y Faiz</div><div class="ind-value" style="color:var(--warn)" id="t10yval">â€”</div><div class="ind-status up">Devlet Tahvili</div></div>
        </div>
      </div>
    </div>

    <!-- SIGNAL -->
    <div class="view" id="view-signal">
      <div class="card">
        <div class="card-title"><span>âš¡</span>Al / Sat / Bekle Sinyali</div>
        <div class="signal-main">
          <div>
            <div style="font-size:10px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px" id="signalTicker">Hisse SeÃ§in</div>
            <div class="signal-action" id="signalAction" style="color:var(--warn)">BEKLE</div>
          </div>
          <div class="confidence-wrap">
            <div class="confidence-score" id="confidenceScore">--</div>
            <div class="confidence-label">GÃ¼ven Skoru</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="confidenceBar" style="width:0%;background:var(--warn)"></div>
        </div>
        <div style="margin-top:14px">
          <div class="card-title" style="margin-bottom:8px">ğŸ“‹ Sinyal GerekÃ§eleri</div>
          <div class="signal-reasons" id="signalReasons">
            <div class="reason-item reason-neutral">Ä°zleme listesinden bir hisse seÃ§in</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸ“</span>Teknik GÃ¶stergeler</div>
        <div class="indicators-grid" id="technicalGrid">
          <div class="indicator-item"><div class="ind-label">RSI (14)</div><div class="skeleton"></div></div>
          <div class="indicator-item"><div class="ind-label">MACD</div><div class="skeleton"></div></div>
          <div class="indicator-item"><div class="ind-label">Stochastic</div><div class="skeleton"></div></div>
          <div class="indicator-item"><div class="ind-label">CCI (20)</div><div class="skeleton"></div></div>
          <div class="indicator-item"><div class="ind-label">BB Width</div><div class="skeleton"></div></div>
          <div class="indicator-item"><div class="ind-label">Momentum</div><div class="skeleton"></div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span>â˜ï¸</span>Ichimoku Analizi</div>
        <div id="ichimokuDisplay">
          <div style="font-size:11px;color:var(--text3);text-align:center;padding:12px">Hisse seÃ§ilince hesaplanacak</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸŒŠ</span>Elliott Wave & Fibonacci</div>
        <div id="elliottDisplay" style="margin-bottom:12px">
          <div style="font-size:11px;color:var(--text3);text-align:center;padding:8px">Hisse seÃ§ilince hesaplanacak</div>
        </div>
        <table class="fib-table" id="fibTable">
          <tr><td>%23.6</td><td>â€”</td></tr>
          <tr><td>%38.2</td><td>â€”</td></tr>
          <tr><td class="fib-key">%61.8 (AltÄ±n)</td><td class="fib-key">â€”</td></tr>
          <tr><td>%78.6</td><td>â€”</td></tr>
          <tr><td>Extension %161.8</td><td>â€”</td></tr>
        </table>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸ¤–</span>AI Analiz</div>
        <div class="ai-box">
          <div class="ai-header">
            <div class="ai-label">Alpha AI</div>
            <div style="display:flex;gap:4px" id="aiThinking"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div></div>
          </div>
          <div class="ai-text" id="aiAnalysisText">Analiz iÃ§in bir hisse seÃ§in ve "AI Analiz Et" butonuna basÄ±n.</div>
        </div>
        <button class="btn-primary" id="analyzeBtn">ğŸ¤– AI ile Analiz Et</button>
      </div>
    </div>

    <!-- OPPORTUNITIES -->
    <div class="view" id="view-opportunities">
      <div class="jackpot-banner">
        <div class="jackpot-emoji">ğŸ¯</div>
        <div class="jackpot-title">GÃ¼nÃ¼n FÄ±rsatlarÄ±</div>
        <div class="jackpot-sub">AI tarafÄ±ndan tespit edilen yÃ¼ksek potansiyelli hisseler</div>
      </div>
      <div id="opportunitiesList"></div>
      <div class="section-divider">ğŸ’ Jackpot RadarÄ±</div>
      <div class="card">
        <div class="card-title"><span>ğŸš€</span>YÃ¼ksek Momentum TarayÄ±cÄ±</div>
        <div id="jackpotList"></div>
        <button class="btn-primary" id="scanBtn">ğŸ” Yeni Tara</button>
      </div>
    </div>

    <!-- UNUSUAL OPTIONS -->
    <div class="view" id="view-unusual">
      <div class="card">
        <div class="card-title"><span>ğŸ”¥</span>Unusual Opsiyon AkÄ±ÅŸÄ±</div>
        <div id="unusualList"></div>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸ“Š</span>Opsiyon Ã–zeti</div>
        <div class="indicators-grid">
          <div class="indicator-item"><div class="ind-label">Put/Call OranÄ±</div><div class="ind-value up">0.72</div><div class="ind-status up">â— Bullish</div></div>
          <div class="indicator-item"><div class="ind-label">Implied Vol</div><div class="ind-value" style="color:var(--warn)">24.3%</div><div class="ind-status" style="color:var(--warn)">â— Orta</div></div>
          <div class="indicator-item"><div class="ind-label">Toplam Prim</div><div class="ind-value" style="color:var(--gold)">$2.4M</div><div class="ind-status up">â–² YÃ¼ksek</div></div>
          <div class="indicator-item"><div class="ind-label">BÃ¼yÃ¼k Ä°ÅŸlem</div><div class="ind-value" style="color:var(--accent)">47</div><div class="ind-status">BugÃ¼n</div></div>
        </div>
      </div>
    </div>

    <!-- NEWS / GEOPOLITICS -->
    <div class="view" id="view-news">
      <div class="card">
        <div class="card-title"><span>ğŸŒ</span>Jeopolitik & Makro Analiz</div>
        <div class="ai-box" style="margin-bottom:12px">
          <div class="ai-text" id="geopoliticalSummary">KÃ¼resel piyasalar Ã¼zerindeki jeopolitik risk faktÃ¶rleri yÃ¼kleniyor...</div>
        </div>
        <button class="btn-primary" id="geoAnalyzeBtn">ğŸŒ Jeopolitik AI Analizi</button>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸ“°</span>Son GeliÅŸmeler</div>
        <div id="newsList"></div>
      </div>
      <div class="card">
        <div class="card-title"><span>âš–ï¸</span>Hukuki & DÃ¼zenleyici</div>
        <div id="legalList"></div>
      </div>
    </div>

    <!-- BOARD -->
    <div class="view" id="view-board">
      <div class="card">
        <div class="card-title"><span>ğŸ‘”</span>YÃ¶netim Kurulu Analizi</div>
        <div style="font-size:11px;color:var(--text3);margin-bottom:12px">SeÃ§ili hisse: <span id="boardTickerLabel" style="color:var(--accent)">â€”</span></div>
        <div id="boardList"></div>
        <button class="btn-primary" id="boardAnalyzeBtn">ğŸ¤– AI ile YÃ¶netim Analizi</button>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸ“‹</span>Insider Trading</div>
        <div id="insiderList"></div>
      </div>
    </div>

    <!-- VALUATION -->
    <div class="view" id="view-valuation">
      <div class="card">
        <div class="card-title"><span>ğŸ’°</span>Temel DeÄŸerleme â€” <span id="valTickerLabel" style="color:var(--accent);font-size:10px">â€”</span></div>
        <div class="val-grid" id="valuationGrid">
          <div class="val-item"><div class="val-label">P/E</div><div class="skeleton"></div></div>
          <div class="val-item"><div class="val-label">P/B</div><div class="skeleton"></div></div>
          <div class="val-item"><div class="val-label">EV/EBITDA</div><div class="skeleton"></div></div>
          <div class="val-item"><div class="val-label">PEG</div><div class="skeleton"></div></div>
          <div class="val-item"><div class="val-label">P/FCF</div><div class="skeleton"></div></div>
          <div class="val-item"><div class="val-label">EV/EBIT</div><div class="skeleton"></div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸ¤–</span>DeÄŸerleme AI Yorumu</div>
        <div class="ai-box">
          <div class="ai-text" id="valuationAI">DeÄŸerleme analizi iÃ§in sol menÃ¼den hisse seÃ§in.</div>
        </div>
        <button class="btn-primary" id="valuationBtn">ğŸ’° DeÄŸerleme Analizi</button>
      </div>
    </div>

    <!-- MICRO CAP -->
    <div class="view" id="view-microcap">
      <div class="jackpot-banner" style="background:linear-gradient(135deg,rgba(255,100,50,0.1),rgba(255,215,0,0.05))">
        <div class="jackpot-emoji">ğŸ’</div>
        <div class="jackpot-title" style="color:#ff6032">MicroCap Jackpot TarayÄ±cÄ±</div>
        <div class="jackpot-sub">Piyasa deÄŸeri $50Mâ€“$300M arasÄ± yÃ¼ksek potansiyelli hisseler</div>
      </div>
      <div id="microcapList"></div>
      <div class="card">
        <div class="card-title"><span>ğŸ¤–</span>AI MicroCap Analizi</div>
        <div class="ai-box">
          <div class="ai-text" id="microcapAI">MicroCap fÄ±rsatlarÄ± iÃ§in "AI Tara" butonuna basÄ±n.</div>
        </div>
        <button class="btn-primary" id="microcapBtn">ğŸ” AI ile MicroCap Tara</button>
      </div>
    </div>

  </main>

  <div class="bottom-nav">
    <div class="bnav-item active" data-view="watchlist"><div class="bnav-icon">ğŸ“Š</div>Ä°zleme</div>
    <div class="bnav-item" data-view="signal"><div class="bnav-icon">âš¡</div>Sinyal</div>
    <div class="bnav-item" data-view="opportunities"><div class="bnav-icon">ğŸ¯</div>FÄ±rsat</div>
    <div class="bnav-item" data-view="unusual"><div class="bnav-icon">ğŸ”¥</div>Unusual</div>
    <div class="bnav-item" data-view="news"><div class="bnav-icon">ğŸŒ</div>Haber</div>
    <div class="bnav-item" data-view="microcap"><div class="bnav-icon">ğŸ’</div>Micro</div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸŒ Global Hisse Ara</div>
    <div style="position:relative;margin-bottom:12px">
      <input class="stock-input" id="stockInput" placeholder="Ticker veya ÅŸirket adÄ± yaz... (AAPL, Apple...)" style="width:100%;padding-right:40px"/>
      <div id="searchSpinner" style="display:none;position:absolute;right:12px;top:50%;transform:translateY(-50%)"><div class="ai-dot"></div></div>
    </div>
    <div style="display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;margin-bottom:12px;padding-bottom:4px" id="exchangeFilter">
      <div class="exch-btn active" data-exch="ALL">TÃ¼mÃ¼</div>
      <div class="exch-btn" data-exch="US">ğŸ‡ºğŸ‡¸ ABD</div>
      <div class="exch-btn" data-exch="LSE">ğŸ‡¬ğŸ‡§ Londra</div>
      <div class="exch-btn" data-exch="TSX">ğŸ‡¨ğŸ‡¦ Toronto</div>
      <div class="exch-btn" data-exch="ASX">ğŸ‡¦ğŸ‡º Avustralya</div>
      <div class="exch-btn" data-exch="XETR">ğŸ‡©ğŸ‡ª Frankfurt</div>
      <div class="exch-btn" data-exch="EPA">ğŸ‡«ğŸ‡· Paris</div>
      <div class="exch-btn" data-exch="TSE">ğŸ‡¯ğŸ‡µ Tokyo</div>
      <div class="exch-btn" data-exch="HKEX">ğŸ‡­ğŸ‡° Hong Kong</div>
      <div class="exch-btn" data-exch="NSE">ğŸ‡®ğŸ‡³ Hindistan</div>
      <div class="exch-btn" data-exch="BIST">ğŸ‡¹ğŸ‡· Ä°stanbul</div>
    </div>
    <div id="searchResults" style="max-height:40vh;overflow-y:auto;scrollbar-width:none"></div>
    <div id="popularSection">
      <div style="font-size:10px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">âš¡ PopÃ¼ler</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px" id="quickAdd"></div>
    </div>
    <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px">
      <div style="font-size:10px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">ğŸ“‹ Ä°zleme Listem</div>
      <div id="watchlistManage" style="display:flex;flex-wrap:wrap;gap:6px"></div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FINNHUB_KEY = 'd6ctgkpr01qgk7mjnqu0d6ctgkpr01qgk7mjnqug';
const WATCHLIST_KEY = 'alpha_watchlist_v2';
const QUICK_TICKERS = ['AAPL','TSLA','NVDA','MSFT','META','GOOGL','AMZN','JPM','PLTR','ARM','BABA','SONY'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let watchlist = (() => {
  try { return JSON.parse(localStorage.getItem(WATCHLIST_KEY) || '["AAPL","TSLA","NVDA"]'); }
  catch(e) { return ['AAPL','TSLA','NVDA']; }
})();
let selectedTicker = watchlist[0] || 'AAPL';
let currentView = 'watchlist';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATIC DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const VALUATION_DATA = {
  AAPL:{pe:29.4,pb:47.2,evEbitda:22.1,peg:2.8,pfcf:26.3,evEbit:24.5},
  TSLA:{pe:55.2,pb:8.9,evEbitda:48.3,peg:1.9,pfcf:68.1,evEbit:52.4},
  NVDA:{pe:68.4,pb:32.1,evEbitda:45.2,peg:0.8,pfcf:52.3,evEbit:48.9},
  MSFT:{pe:35.2,pb:12.4,evEbitda:24.8,peg:2.1,pfcf:31.5,evEbit:26.3},
  META:{pe:24.8,pb:7.2,evEbitda:14.2,peg:1.2,pfcf:19.8,evEbit:15.6},
  GOOGL:{pe:22.4,pb:6.8,evEbitda:16.3,peg:1.4,pfcf:20.1,evEbit:17.8},
  AMZN:{pe:42.1,pb:8.9,evEbitda:18.4,peg:1.6,pfcf:35.2,evEbit:22.7},
  JPM:{pe:11.8,pb:1.8,evEbitda:8.2,peg:1.1,pfcf:null,evEbit:9.4},
  PLTR:{pe:78.2,pb:18.4,evEbitda:52.1,peg:1.4,pfcf:61.2,evEbit:55.3},
};

const BOARD_DATA = {
  AAPL:[
    {name:'Tim Cook',role:'CEO',initials:'TC',score:'9.2/10',bio:'2011\'den beri CEO. Apple\'Ä± $1T\'dan $3T piyasa deÄŸerine taÅŸÄ±dÄ±. Tedarik zinciri uzmanÄ±. Ã‡in riskleri nedeniyle baskÄ± altÄ±nda.'},
    {name:'Luca Maestri',role:'CFO',initials:'LM',score:'8.7/10',bio:'2014\'ten beri CFO. Agresif hisse geri alÄ±m programÄ± ($90B+). GÃ¼Ã§lÃ¼ serbest nakit akÄ±ÅŸÄ± yÃ¶netimi.'},
    {name:'Arthur Levinson',role:'Chairman',initials:'AL',score:'8.9/10',bio:'Genentech eski CEO\'su. SaÄŸlÄ±k teknolojisi konusunda stratejik rehberlik saÄŸlÄ±yor.'},
  ],
  TSLA:[
    {name:'Elon Musk',role:'CEO',initials:'EM',score:'7.1/10',bio:'Vizyoner lider ama X/Twitter dikkat daÄŸÄ±tÄ±cÄ± risk. AI ile Tesla Ã§atÄ±ÅŸmasÄ± tartÄ±ÅŸmalÄ±. Her aÃ§Ä±klamasÄ± hisse fiyatÄ±nÄ± hareket ettiriyor.'},
    {name:'Vaibhav Taneja',role:'CFO',initials:'VT',score:'7.8/10',bio:'2023\'ten CFO. Maliyet dÃ¼ÅŸÃ¼rme kampanyalarÄ± yÃ¼rÃ¼tÃ¼yor.'},
  ],
  NVDA:[
    {name:'Jensen Huang',role:'CEO/Founder',initials:'JH',score:'9.8/10',bio:'NVIDIA\'yÄ± GPU ÅŸirketinden AI altyapÄ± devine dÃ¶nÃ¼ÅŸtÃ¼rdÃ¼. CUDA ekosistemi rakipsiz. En etkili CEO\'lardan biri.'},
    {name:'Colette Kress',role:'CFO',initials:'CK',score:'9.1/10',bio:'2013\'ten beri CFO. Veri merkezi geÃ§iÅŸini mÃ¼kemmel yÃ¶netti.'},
  ],
};

const UNUSUAL_OPTIONS = [
  {ticker:'NVDA',type:'CALL',strike:'$900',expiry:'Mar 28',volume:'12,450',oi:'2,100',premium:'$8.2M',sentiment:'Bullish Sweep'},
  {ticker:'TSLA',type:'PUT',strike:'$230',expiry:'Mar 15',volume:'8,320',oi:'1,850',premium:'$3.1M',sentiment:'Bearish Block'},
  {ticker:'META',type:'CALL',strike:'$530',expiry:'Apr 19',volume:'5,670',oi:'890',premium:'$4.5M',sentiment:'Bullish Block'},
  {ticker:'AAPL',type:'CALL',strike:'$195',expiry:'Mar 21',volume:'9,140',oi:'3,200',premium:'$2.8M',sentiment:'Bullish Sweep'},
  {ticker:'AMZN',type:'PUT',strike:'$185',expiry:'Mar 28',volume:'4,280',oi:'720',premium:'$1.9M',sentiment:'Bearish Sweep'},
  {ticker:'PLTR',type:'CALL',strike:'$28',expiry:'Apr 5',volume:'18,900',oi:'4,100',premium:'$1.2M',sentiment:'Unusual Bullish'},
];

const NEWS_DATA = [
  {title:'Fed faiz kararÄ±: 2024 iÃ§inde 3 indirim beklentisi korundu',impact:'high',source:'Reuters',time:'2s Ã¶nce',sentiment:'bull',tickers:['SPY','TLT']},
  {title:'Ã‡in-Taiwan gerilimi: YarÄ± iletken ihracat kÄ±sÄ±tlamalarÄ± gÃ¼ndemde',impact:'high',source:'Bloomberg',time:'1s Ã¶nce',sentiment:'bear',tickers:['NVDA','AMD','TSM']},
  {title:'OpenAI GPT-5 duyurusu NVIDIA hisselerini yukarÄ± taÅŸÄ±yabilir',impact:'med',source:'TechCrunch',time:'3s Ã¶nce',sentiment:'bull',tickers:['NVDA','MSFT']},
  {title:'Apple Vision Pro satÄ±ÅŸlarÄ± beklentilerin altÄ±nda kaldÄ±',impact:'med',source:'WSJ',time:'4s Ã¶nce',sentiment:'bear',tickers:['AAPL']},
  {title:'AB yapay zeka dÃ¼zenlemesi: BÃ¼yÃ¼k teknoloji ÅŸirketlerine yeni yÃ¼k',impact:'med',source:'FT',time:'5s Ã¶nce',sentiment:'bear',tickers:['META','GOOGL','MSFT']},
  {title:'Tesla Cybertruck hatasÄ±: 2,200 araÃ§ geri Ã§aÄŸrÄ±ldÄ±',impact:'high',source:'CNBC',time:'6s Ã¶nce',sentiment:'bear',tickers:['TSLA']},
];

const LEGAL_DATA = [
  {title:'DOJ Anti-tekel davasÄ±: Google arama monopolÃ¼ kararÄ± bekleniyor',impact:'high',tickers:['GOOGL']},
  {title:'SEC: Kripto hisseleri iÃ§in yeni aÃ§Ä±klama zorunluluÄŸu',impact:'med',tickers:['COIN']},
  {title:'Meta Platforms: AB\'den â‚¬1.2B veri gizliliÄŸi cezasÄ±',impact:'high',tickers:['META']},
];

const OPPORTUNITIES = [
  {ticker:'PLTR',name:'Palantir Tech.',upside:'+34%',reason:'AI hÃ¼kÃ¼met sÃ¶zleÅŸmeleri artÄ±yor. AIP platformu momentum kazanÄ±yor. KÃ¢rlÄ±lÄ±k dÃ¶nemi baÅŸladÄ±.',tags:['AI','GOV','Momentum','Breakout']},
  {ticker:'NVDA',name:'NVIDIA Corp.',upside:'+28%',reason:'Blackwell GPU talebi arz kapasitesinin Ã§ok Ã¼zerinde. Veri merkezi bÃ¼yÃ¼mesi hÄ±zlanÄ±yor.',tags:['AI','DataCenter','Semiconductor']},
  {ticker:'META',name:'Meta Platforms',upside:'+22%',reason:'Reklam geliri beklentileri aÅŸÄ±yor. Llama AI modeli gÃ¼Ã§lÃ¼. Ucuz deÄŸerleme + gÃ¼Ã§lÃ¼ FCF.',tags:['Social','AI','Value','FCF']},
];

const JACKPOT_STOCKS = [
  {ticker:'SMCI',name:'Super Micro Computer',reason:'AI sunucu patlama, RSI dipten dÃ¶nÃ¼ÅŸ, insider alÄ±m var',pct:'+67% potansiyel',risk:'YÃœKSEK'},
  {ticker:'ARM',name:'ARM Holdings',reason:'TÃ¼m AI Ã§ipleri ARM mimarisi kullanÄ±yor. Lisans geliri patlÄ±yor',pct:'+45% potansiyel',risk:'ORTA'},
  {ticker:'IONQ',name:'IonQ Inc.',reason:'Kuantum bilgisayar sektÃ¶rÃ¼ erken faz. Microsoft & AWS ortaklÄ±klarÄ±',pct:'+120% potansiyel',risk:'Ã‡OK YÃœKSEK'},
];

const MICROCAP_STOCKS = [
  {ticker:'RKLB',name:'Rocket Lab USA',mc:'$4.2B',sector:'Space',reason:'SpaceX\'e rakip. Neutron roketi 2025\'te. Uydu servisleri bÃ¼yÃ¼yor. NASA sÃ¶zleÅŸmeleri.',pct:'+89%',risk:'YÃœKSEK',score:82},
  {ticker:'BBAI',name:'BigBear.ai Holdings',mc:'$280M',sector:'AI/Defense',reason:'Savunma AI sÃ¶zleÅŸmeleri. DoD ile entegrasyon. DÃ¼ÅŸÃ¼k piyasa deÄŸeri yÃ¼ksek bÃ¼yÃ¼me.',pct:'+145%',risk:'Ã‡OK YÃœKSEK',score:74},
  {ticker:'CLOV',name:'Clover Health',mc:'$190M',sector:'HealthTech AI',reason:'AI-driven saÄŸlÄ±k yÃ¶netimi. Medicare Advantage bÃ¼yÃ¼mesi. Derin iskontolu.',pct:'+110%',risk:'YÃœKSEK',score:61},
  {ticker:'OUST',name:'Ouster Inc.',mc:'$220M',sector:'LiDAR/AV',reason:'Otomasyonun gÃ¶zÃ¼: LiDAR. Otonom araÃ§ tedarikÃ§isi. Velodyne birleÅŸmesi tamamlandÄ±.',pct:'+95%',risk:'YÃœKSEK',score:68},
  {ticker:'GFAI',name:'Guardforce AI',mc:'$45M',sector:'Security AI',reason:'Asya gÃ¼venlik otomasyonu. KÃ¼Ã§Ã¼k piyasa deÄŸeri bÃ¼yÃ¼k fÄ±rsat. Nano-cap.',pct:'+200%',risk:'EKSTREm',score:55},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CACHE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const priceCache = {};
const candleCache = {};
const profileCache = {};
const financialsCache = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINNHUB API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function finnhub(path, params={}) {
  const url = new URL('https://finnhub.io/api/v1' + path);
  url.searchParams.set('token', FINNHUB_KEY);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));
  try {
    const res = await fetch(url.toString());
    return await res.json();
  } catch(e) { return null; }
}

async function fetchQuote(ticker) {
  const cached = priceCache[ticker];
  if (cached && Date.now()-cached.ts < 15000) return cached;
  const d = await finnhub('/quote', {symbol:ticker});
  if (!d || !d.c) return cached || null;
  const result = {
    price:d.c, change:+(d.c-d.pc).toFixed(2),
    changePct:d.pc ? +((d.c-d.pc)/d.pc*100).toFixed(2) : 0,
    high:d.h, low:d.l, open:d.o, prevClose:d.pc, ts:Date.now()
  };
  priceCache[ticker] = result;
  return result;
}

async function fetchCandles(ticker) {
  if (candleCache[ticker] && Date.now()-candleCache[ticker].ts < 3600000) return candleCache[ticker].prices;
  const now = Math.floor(Date.now()/1000);
  const from = now - 90*24*3600;
  const d = await finnhub('/stock/candle', {symbol:ticker, resolution:'D', from, to:now});
  if (!d || d.s !== 'ok') return null;
  candleCache[ticker] = {prices:d.c, ts:Date.now()};
  return d.c;
}

async function fetchProfile(ticker) {
  if (profileCache[ticker]) return profileCache[ticker];
  const d = await finnhub('/stock/profile2', {symbol:ticker});
  if (d && d.name) { profileCache[ticker]=d; return d; }
  return null;
}

async function fetchFinancials(ticker) {
  if (financialsCache[ticker] && Date.now()-financialsCache[ticker].ts < 3600000) return financialsCache[ticker];
  const d = await finnhub('/stock/metric', {symbol:ticker, metric:'all'});
  if (!d || !d.metric) return null;
  const m = d.metric;
  const result = {
    pe:m.peNormalizedAnnual, pb:m.pbAnnual, ps:m.psAnnual,
    evEbitda:m.evEbitdaTTM, beta:m.beta,
    high52w:m['52WeekHigh'], low52w:m['52WeekLow'],
    grossMargin:m.grossMarginTTM, netMargin:m.netProfitMarginTTM,
    revenueGrowth:m.revenueGrowthTTMYoy, ts:Date.now()
  };
  financialsCache[ticker] = result;
  return result;
}

async function fetchBoard(ticker) {
  const d = await finnhub('/stock/executive', {symbol:ticker});
  return (d && d.executive) ? d.executive : [];
}

async function fetchInsider(ticker) {
  const d = await finnhub('/stock/insider-transactions', {symbol:ticker});
  return (d && d.data) ? d.data.slice(0,8) : [];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TECHNICAL INDICATORS â€” FIX: clean implementations
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcRSI(prices, period=14) {
  if (!prices || prices.length < period+1) return 50;
  let gains=0, losses=0;
  for (let i=prices.length-period; i<prices.length; i++) {
    const diff = prices[i] - prices[i-1];
    if (diff>0) gains+=diff; else losses-=diff;
  }
  const ag=gains/period, al=losses/period;
  return +(100 - 100/(1 + ag/(al||0.001))).toFixed(1);
}

function calcEMA(prices, period) {
  if (!prices || prices.length < period) return prices ? prices[prices.length-1] : 0;
  const k = 2/(period+1);
  let ema = prices.slice(0,period).reduce((a,b)=>a+b,0)/period;
  for (let i=period; i<prices.length; i++) ema = prices[i]*k + ema*(1-k);
  return ema;
}

function calcMACD(prices) {
  if (!prices || prices.length < 26) return 0;
  return +(calcEMA(prices,12) - calcEMA(prices,26)).toFixed(2);
}

function calcStoch(prices, period=14) {
  if (!prices || prices.length < period) return 50;
  const slice = prices.slice(-period);
  const low=Math.min(...slice), high=Math.max(...slice);
  return +(((prices[prices.length-1]-low)/(high-low||1))*100).toFixed(1);
}

function calcCCI(prices, period=20) {
  if (!prices || prices.length < period) return 0;
  const slice = prices.slice(-period);
  const avg = slice.reduce((a,b)=>a+b,0)/period;
  const md = slice.reduce((a,b)=>a+Math.abs(b-avg),0)/period;
  return +((prices[prices.length-1]-avg)/(0.015*(md||1))).toFixed(0);
}

function calcBBWidth(prices, period=20) {
  if (!prices || prices.length < period) return 5;
  const slice = prices.slice(-period);
  const avg = slice.reduce((a,b)=>a+b,0)/period;
  const std = Math.sqrt(slice.reduce((a,b)=>a+(b-avg)**2,0)/period);
  return +((std*4/(avg||1))*100).toFixed(1);
}

function calcMomentum(prices, period=10) {
  if (!prices || prices.length < period+1) return 0;
  return +(prices[prices.length-1] - prices[prices.length-1-period]).toFixed(2);
}

// Ichimoku Cloud calculation
function calcIchimoku(prices) {
  if (!prices || prices.length < 52) return null;
  const hi = (arr,n) => Math.max(...arr.slice(-n));
  const lo = (arr,n) => Math.min(...arr.slice(-n));
  const tenkan = (hi(prices,9)+lo(prices,9))/2;
  const kijun = (hi(prices,26)+lo(prices,26))/2;
  const senkouA = (tenkan+kijun)/2;
  const senkouB = (hi(prices,52)+lo(prices,52))/2;
  const chikou = prices[prices.length-1];
  const price = prices[prices.length-1];
  const aboveCloud = price > Math.max(senkouA, senkouB);
  const belowCloud = price < Math.min(senkouA, senkouB);
  const inCloud = !aboveCloud && !belowCloud;
  const bullish = tenkan > kijun;
  return { tenkan:+tenkan.toFixed(2), kijun:+kijun.toFixed(2), senkouA:+senkouA.toFixed(2), senkouB:+senkouB.toFixed(2), chikou:+chikou.toFixed(2), aboveCloud, belowCloud, inCloud, bullish };
}

// Simple Elliott Wave count (trend identification)
function detectElliott(prices) {
  if (!prices || prices.length < 20) return null;
  const recent = prices.slice(-20);
  const first = recent[0], last = recent[recent.length-1];
  const trend = last > first ? 'YUKARI' : 'AÅAÄI';
  // Find local peaks and troughs
  const pivots = [];
  for (let i=1; i<recent.length-1; i++) {
    if (recent[i]>recent[i-1] && recent[i]>recent[i+1]) pivots.push({type:'peak',val:recent[i],i});
    else if (recent[i]<recent[i-1] && recent[i]<recent[i+1]) pivots.push({type:'trough',val:recent[i],i});
  }
  const waveCount = pivots.length;
  let wave = '?', phase = 'Belirsiz';
  if (waveCount >= 5 && trend==='YUKARI') { wave='3-5'; phase='YÃ¼kseliÅŸ dalgasÄ± â€” ivme gÃ¼Ã§lÃ¼'; }
  else if (waveCount >= 3 && trend==='YUKARI') { wave='1-3'; phase='Erken yÃ¼kseliÅŸ â€” alÄ±m fÄ±rsatÄ±'; }
  else if (trend==='AÅAÄI' && waveCount>=3) { wave='A-C'; phase='DÃ¼zeltme dalgasÄ± â€” bekle'; }
  else { wave='1'; phase='BaÅŸlangÄ±Ã§ dalgasÄ± â€” izle'; }
  return { trend, wave, phase, pivots:waveCount };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FALLBACK PRICE GENERATOR (for tickers without real data)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRICE_BASES = {AAPL:189,TSLA:248,NVDA:875,MSFT:420,META:512,GOOGL:175,AMZN:193,JPM:201,PLTR:24,ARM:110,BABA:72,SONY:82};

function generatePrices(ticker, days=90) {
  const base = PRICE_BASES[ticker] || 100;
  const prices = [];
  let p = base * 0.85;
  for (let i=0; i<=days; i++) {
    p = Math.max(p + (Math.random()-0.47)*p*0.022, base*0.4);
    prices.push(+p.toFixed(2));
  }
  return prices;
}

// FIX: getStockData was missing â€” now properly defined
function getStockData(ticker) {
  const q = priceCache[ticker];
  const profile = profileCache[ticker];
  const base = PRICE_BASES[ticker] || 100;
  return {
    price: q ? q.price : base,
    change: q ? q.change : 0,
    changePct: q ? q.changePct : 0,
    name: profile ? profile.name : (LOCAL_DB.find(d=>d.s===ticker)?.n || ticker),
    sector: profile ? profile.finnhubIndustry : 'Technology',
    base
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveWatchlist() {
  localStorage.setItem(WATCHLIST_KEY, JSON.stringify(watchlist));
}

function renderWatchlist() {
  const el = document.getElementById('watchlistItems');
  if (!watchlist.length) {
    el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)">Ä°zleme listeniz boÅŸ.<br>+ butonuna basarak hisse ekleyin.</div>';
    return;
  }
  el.innerHTML = watchlist.map(ticker => {
    const q = priceCache[ticker];
    const name = profileCache[ticker]?.name || LOCAL_DB.find(d=>d.s===ticker)?.n || ticker;
    const price = q ? q.price : null;
    const changePct = q ? q.changePct : 0;
    const up = changePct >= 0;
    const priceStr = price!=null ? '$'+price.toFixed(2) : 'â€”';
    const changeStr = price!=null ? `${up?'+':''}${changePct.toFixed(2)}%` : 'â€”';
    const prices = candleCache[ticker]?.prices;
    let sigAction='â€”', sigClass='signal-hold';
    if (prices && prices.length>20) {
      const rsi=calcRSI(prices), macd=calcMACD(prices);
      let bull=0,bear=0;
      if(rsi<35) bull+=2; else if(rsi>65) bear+=2;
      if(macd>0) bull+=2; else bear+=2;
      if(changePct>1) bull+=1; else if(changePct<-1) bear+=1;
      if(bull>bear+1){sigAction='AL';sigClass='signal-buy';}
      else if(bear>bull+1){sigAction='SAT';sigClass='signal-sell';}
      else{sigAction='BEKLE';sigClass='signal-hold';}
    }
    const sel = selectedTicker===ticker;
    return `<div class="watchlist-item" style="${sel?'background:rgba(0,212,255,0.05);border-left:2px solid var(--accent);':''}" onclick="selectTicker('${ticker}')">
      <div>
        <div class="ticker-symbol">${ticker}</div>
        <div class="ticker-name">${name.length>22?name.slice(0,22)+'...':name}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <div class="ticker-price ${price!=null?(up?'up':'down'):''}">${priceStr}</div>
        <div style="display:flex;gap:4px;align-items:center">
          <div class="ticker-change ${up?'bg-up':'bg-down'}">${changeStr}</div>
          <div class="signal-badge ${sigClass}">${sigAction}</div>
        </div>
      </div>
    </div>`;
  }).join('');
  updateMarketSummary();
}

async function updateMarketSummary() {
  const spyQ = await fetchQuote('SPY');
  const vixQ = await fetchQuote('VIX');
  const dxyQ = await fetchQuote('DX-Y.NYB');
  const t10yQ = await fetchQuote('TNX');
  if(spyQ){
    document.getElementById('sp500val').textContent = '$'+spyQ.price.toFixed(2);
    document.getElementById('sp500chg').textContent = (spyQ.changePct>=0?'â–² +':'â–¼ ')+spyQ.changePct.toFixed(2)+'%';
    document.getElementById('sp500chg').className = 'ind-status '+(spyQ.changePct>=0?'up':'down');
  }
  if(vixQ){
    document.getElementById('vixval').textContent = vixQ.price.toFixed(1);
    const vixLbl = vixQ.price<15?'â— DÃ¼ÅŸÃ¼k Risk':vixQ.price<25?'â— Orta Risk':'â— YÃ¼ksek Risk';
    document.getElementById('vixlbl').textContent = vixLbl;
  }
  if(dxyQ){
    document.getElementById('dxyval').textContent = dxyQ.price.toFixed(2);
    document.getElementById('dxychg').textContent = (dxyQ.changePct>=0?'â–² +':'â–¼ ')+dxyQ.changePct.toFixed(2)+'%';
  }
  if(t10yQ){
    document.getElementById('t10yval').textContent = t10yQ.price.toFixed(2)+'%';
  }
}

async function renderMiniChart(ticker) {
  document.getElementById('chartLabel').textContent = `${ticker} â€” YÃ¼kleniyor...`;
  let prices = candleCache[ticker]?.prices || await fetchCandles(ticker) || generatePrices(ticker,30);
  prices = prices.slice(-30);
  const q = await fetchQuote(ticker);

  const canvas = document.getElementById('miniChart');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 2;
  canvas.width = canvas.offsetWidth*dpr;
  canvas.height = canvas.offsetHeight*dpr;
  ctx.scale(dpr,dpr);
  const W=canvas.offsetWidth, H=canvas.offsetHeight;
  const min=Math.min(...prices), max=Math.max(...prices);
  const range=max-min||1;
  ctx.clearRect(0,0,W,H);
  const up = prices[prices.length-1] >= prices[0];
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, up?'rgba(0,230,118,0.3)':'rgba(255,59,92,0.3)');
  grad.addColorStop(1,'rgba(0,0,0,0)');
  const pts = prices.map((p,i)=>({x:(i/(prices.length-1))*W, y:H-((p-min)/range)*(H-10)-5}));
  ctx.beginPath();
  pts.forEach((pt,i)=>i===0?ctx.moveTo(pt.x,pt.y):ctx.lineTo(pt.x,pt.y));
  ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
  ctx.fillStyle=grad; ctx.fill();
  ctx.beginPath();
  pts.forEach((pt,i)=>i===0?ctx.moveTo(pt.x,pt.y):ctx.lineTo(pt.x,pt.y));
  ctx.strokeStyle=up?'#00e676':'#ff3b5c'; ctx.lineWidth=2; ctx.stroke();

  const priceTxt = q ? ` â€” $${q.price.toFixed(2)} (${q.changePct>=0?'+':''}${q.changePct.toFixed(2)}%)` : '';
  document.getElementById('chartLabel').textContent = `${ticker} â€” 30 GÃ¼nlÃ¼k${priceTxt}`;
  renderWatchlist();
}

// FIX: Single renderSignal function (was duplicated & broken)
async function renderSignal(ticker) {
  if (!ticker) return;
  document.getElementById('signalTicker').textContent = ticker;
  document.getElementById('boardTickerLabel').textContent = ticker;
  document.getElementById('valTickerLabel').textContent = ticker;

  let prices = candleCache[ticker]?.prices || await fetchCandles(ticker);
  if (!prices || prices.length < 30) prices = generatePrices(ticker, 90);
  const q = priceCache[ticker] || await fetchQuote(ticker);
  const changePct = q?.changePct || 0;

  const rsi = calcRSI(prices);
  const macd = calcMACD(prices);
  const stoch = calcStoch(prices);
  const cci = calcCCI(prices);
  const bbw = calcBBWidth(prices);
  const mom = calcMomentum(prices);

  let bull=0, bear=0, reasons=[];
  if(rsi<35){bull+=2;reasons.push({text:`RSI aÅŸÄ±rÄ± satÄ±m (${rsi}) â€” alÄ±m fÄ±rsatÄ±`,bull:true});}
  else if(rsi>65){bear+=2;reasons.push({text:`RSI aÅŸÄ±rÄ± alÄ±m (${rsi}) â€” sat uyarÄ±sÄ±`,bull:false});}
  else reasons.push({text:`RSI nÃ¶tr bÃ¶lge (${rsi})`,bull:null});
  if(macd>0){bull+=2;reasons.push({text:`MACD pozitif (${macd}) â€” yukarÄ± momentum`,bull:true});}
  else{bear+=2;reasons.push({text:`MACD negatif (${macd}) â€” aÅŸaÄŸÄ± baskÄ±`,bull:false});}
  if(stoch<20){bull+=1;reasons.push({text:`Stochastic aÅŸÄ±rÄ± satÄ±m (${stoch})`,bull:true});}
  else if(stoch>80){bear+=1;reasons.push({text:`Stochastic aÅŸÄ±rÄ± alÄ±m (${stoch})`,bull:false});}
  if(cci<-100){bull+=1;reasons.push({text:`CCI aÅŸÄ±rÄ± satÄ±m (${cci}) â€” dip yakÄ±n`,bull:true});}
  else if(cci>100){bear+=1;reasons.push({text:`CCI aÅŸÄ±rÄ± alÄ±m (${cci})`,bull:false});}
  if(changePct>1){bull+=1;reasons.push({text:`GÃ¼Ã§lÃ¼ gÃ¼nlÃ¼k momentum (+${changePct.toFixed(2)}%)`,bull:true});}
  else if(changePct<-1){bear+=1;reasons.push({text:`ZayÄ±f gÃ¼nlÃ¼k momentum (${changePct.toFixed(2)}%)`,bull:false});}

  // Ichimoku signal
  const ichi = calcIchimoku(prices);
  if (ichi) {
    if(ichi.aboveCloud && ichi.bullish){bull+=2;reasons.push({text:`Ichimoku: Fiyat bulutun Ã¼zerinde + Tenkan > Kijun â€” GÃ¼Ã§lÃ¼ Bullish`,bull:true});}
    else if(ichi.belowCloud && !ichi.bullish){bear+=2;reasons.push({text:`Ichimoku: Fiyat bulutun altÄ±nda â€” Bearish baskÄ±`,bull:false});}
    else reasons.push({text:`Ichimoku: Fiyat bulut iÃ§inde â€” Konsolidasyon`,bull:null});
  }

  const total=bull+bear;
  const confidence=total>0?Math.round((Math.max(bull,bear)/total)*100):50;
  let action,color;
  if(bull>bear+1){action='AL';color='var(--green)';}
  else if(bear>bull+1){action='SAT';color='var(--red)';}
  else{action='BEKLE';color='var(--warn)';}

  document.getElementById('signalAction').textContent=action;
  document.getElementById('signalAction').style.color=color;
  document.getElementById('confidenceScore').textContent=confidence+'%';
  const bar=document.getElementById('confidenceBar');
  bar.style.width=confidence+'%'; bar.style.background=color;
  document.getElementById('signalReasons').innerHTML=reasons.map(r=>`
    <div class="reason-item ${r.bull===true?'reason-bull':r.bull===false?'reason-bear':'reason-neutral'}">
      ${r.bull===true?'â–²':r.bull===false?'â–¼':'â—'} ${r.text}
    </div>`).join('');

  document.getElementById('technicalGrid').innerHTML=`
    <div class="indicator-item"><div class="ind-label">RSI (14)</div><div class="ind-value ${rsi<30?'up':rsi>70?'down':''}">${rsi}</div><div class="ind-status">${rsi<30?'AÅŸÄ±rÄ± SatÄ±m':rsi>70?'AÅŸÄ±rÄ± AlÄ±m':'NÃ¶tr'}</div></div>
    <div class="indicator-item"><div class="ind-label">MACD</div><div class="ind-value ${macd>0?'up':'down'}">${macd}</div><div class="ind-status ${macd>0?'up':'down'}">${macd>0?'Bullish':'Bearish'}</div></div>
    <div class="indicator-item"><div class="ind-label">Stochastic</div><div class="ind-value ${stoch<20?'up':stoch>80?'down':''}">${stoch}%</div><div class="ind-status">${stoch<20?'AÅŸÄ±rÄ± SatÄ±m':stoch>80?'AÅŸÄ±rÄ± AlÄ±m':'Normal'}</div></div>
    <div class="indicator-item"><div class="ind-label">CCI (20)</div><div class="ind-value ${cci<-100?'up':cci>100?'down':''}">${cci}</div><div class="ind-status">${cci<-100?'SatÄ±m':cci>100?'AlÄ±m':'NÃ¶tr'}</div></div>
    <div class="indicator-item"><div class="ind-label">BB Width</div><div class="ind-value" style="color:var(--warn)">${bbw}%</div><div class="ind-status" style="color:var(--warn)">${parseFloat(bbw)<7?'KÄ±rÄ±lÄ±m YakÄ±n':'Normal'}</div></div>
    <div class="indicator-item"><div class="ind-label">Momentum</div><div class="ind-value ${mom>0?'up':'down'}">${mom>0?'+':''}${mom}</div><div class="ind-status ${mom>0?'up':'down'}">${mom>0?'â–² Pozitif':'â–¼ Negatif'}</div></div>`;

  // Ichimoku display
  if (ichi) {
    const cloudColor = ichi.aboveCloud?'var(--green)':ichi.belowCloud?'var(--red)':'var(--warn)';
    const cloudLabel = ichi.aboveCloud?'Ãœzerinde ğŸŸ¢':ichi.belowCloud?'AltÄ±nda ğŸ”´':'Ä°Ã§inde ğŸŸ¡';
    document.getElementById('ichimokuDisplay').innerHTML=`
      <div style="padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:8px">
        <div style="font-size:11px;color:${cloudColor};font-weight:700;margin-bottom:6px">
          ${ichi.aboveCloud?'ğŸŸ¢ BULLISH â€” Fiyat bulutun Ã¼zerinde':ichi.belowCloud?'ğŸ”´ BEARISH â€” Fiyat bulutun altÄ±nda':'ğŸŸ¡ NÃ–TR â€” Konsolidasyon bÃ¶lgesi'}
        </div>
        <div style="font-size:10px;color:var(--text2)">
          ${ichi.bullish?'â–² Tenkan-sen > Kijun-sen (Bullish Crossover)':'â–¼ Tenkan-sen < Kijun-sen (Bearish Signal)'}
        </div>
      </div>
      <div class="ichi-grid">
        <div class="ichi-item"><div class="ichi-label">Tenkan-sen</div><div class="ichi-val" style="color:var(--accent)">$${ichi.tenkan}</div></div>
        <div class="ichi-item"><div class="ichi-label">Kijun-sen</div><div class="ichi-val" style="color:var(--warn)">$${ichi.kijun}</div></div>
        <div class="ichi-item"><div class="ichi-label">Senkou A</div><div class="ichi-val" style="color:var(--green)">$${ichi.senkouA}</div></div>
        <div class="ichi-item"><div class="ichi-label">Senkou B</div><div class="ichi-val" style="color:var(--red)">$${ichi.senkouB}</div></div>
        <div class="ichi-item"><div class="ichi-label">Chikou</div><div class="ichi-val">$${ichi.chikou}</div></div>
        <div class="ichi-item"><div class="ichi-label">Bulut</div><div class="ichi-val" style="color:${cloudColor}">${cloudLabel}</div></div>
      </div>`;
  }

  // Elliott Wave
  const elliott = detectElliott(prices);
  if (elliott) {
    const trendColor = elliott.trend==='YUKARI'?'var(--green)':'var(--red)';
    document.getElementById('elliottDisplay').innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px">
        <div>
          <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Elliott Wave</div>
          <div style="font-size:13px;font-weight:700;color:${trendColor}">Dalga ${elliott.wave} â€” ${elliott.trend}</div>
          <div style="font-size:10px;color:var(--text2);margin-top:2px">${elliott.phase}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:9px;color:var(--text3)">Tespit edilen pivot</div>
          <div style="font-family:'Space Mono';font-size:14px;color:var(--accent)">${elliott.pivots}</div>
        </div>
      </div>`;
  }

  // Fibonacci
  const high=Math.max(...prices.slice(-60)), low=Math.min(...prices.slice(-60));
  const fibRange=high-low;
  const fibs=[23.6,38.2,50,61.8,78.6].map(f=>({level:f,price:(high-fibRange*(f/100)).toFixed(2)}));
  const ext=(high+fibRange*0.618).toFixed(2);
  document.getElementById('fibTable').innerHTML=fibs.map(f=>`
    <tr>
      <td ${f.level===61.8?'class="fib-key"':''}>${f.level===61.8?'%61.8 (AltÄ±n Oran)':'%'+f.level}</td>
      <td ${f.level===61.8?'class="fib-key"':''}>$${f.price}</td>
    </tr>`).join('')+`<tr><td>Extension %161.8</td><td style="color:var(--green)">$${ext}</td></tr>`;
}

function renderOpportunities() {
  document.getElementById('opportunitiesList').innerHTML=OPPORTUNITIES.map(o=>`
    <div class="opp-card">
      <div class="opp-header">
        <div><div class="opp-ticker">${o.ticker}</div><div style="font-size:10px;color:var(--text3)">${o.name}</div></div>
        <div><div class="opp-upside">${o.upside}</div><div style="font-size:9px;color:var(--text3)">hedef</div></div>
      </div>
      <div class="opp-reason">${o.reason}</div>
      <div class="opp-tags">${o.tags.map(t=>`<span class="opp-tag">${t}</span>`).join('')}</div>
    </div>`).join('');
  document.getElementById('jackpotList').innerHTML=JACKPOT_STOCKS.map(j=>`
    <div class="unusual-item">
      <div class="unusual-header">
        <div class="unusual-ticker" style="color:var(--gold)">${j.ticker} ğŸ’</div>
        <div class="unusual-size">${j.pct}</div>
      </div>
      <div class="unusual-detail">${j.name}</div>
      <div style="font-size:10px;color:var(--text2);margin-top:4px">${j.reason}</div>
      <div style="margin-top:4px"><span class="unusual-type ${j.risk.includes('YÃœKSEK')?'put-type':'call-type'}">Risk: ${j.risk}</span></div>
    </div>`).join('');
}

function renderUnusual() {
  document.getElementById('unusualList').innerHTML=UNUSUAL_OPTIONS.map(u=>`
    <div class="unusual-item">
      <div class="unusual-header">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="unusual-ticker">${u.ticker}</div>
          <div class="unusual-type ${u.type==='CALL'?'call-type':'put-type'}">${u.type}</div>
        </div>
        <div class="unusual-size">${u.premium}</div>
      </div>
      <div class="unusual-detail">Strike: ${u.strike} | Exp: ${u.expiry} | Vol: ${u.volume} | OI: ${u.oi}</div>
      <div style="font-size:10px;color:${u.type==='CALL'?'var(--green)':'var(--red)'};margin-top:3px">${u.sentiment}</div>
    </div>`).join('');
}

// FIX: Single renderNews function (was duplicated)
function renderNews() {
  document.getElementById('newsList').innerHTML=NEWS_DATA.map(n=>`
    <div class="news-item">
      <div class="news-header">
        <div class="news-title">${n.title}</div>
        <div class="news-impact ${n.impact==='high'?'impact-high':n.impact==='med'?'impact-med':'impact-low'}">${n.impact.toUpperCase()}</div>
      </div>
      <div class="news-meta">${n.source} Â· ${n.time}
        <span class="${n.sentiment==='bull'?'sent-bull':'sent-bear'}">${n.sentiment==='bull'?'â–² Bullish':'â–¼ Bearish'}</span>
        Â· ${n.tickers.join(', ')}
      </div>
    </div>`).join('');
  document.getElementById('legalList').innerHTML=LEGAL_DATA.map(l=>`
    <div class="news-item">
      <div class="news-header">
        <div class="news-title">${l.title}</div>
        <div class="news-impact ${l.impact==='high'?'impact-high':'impact-med'}">${l.impact.toUpperCase()}</div>
      </div>
      <div class="news-meta">${l.tickers.join(', ')}</div>
    </div>`).join('');
}

// FIX: Single renderBoard (was duplicated; async version used)
async function renderBoard(ticker) {
  if (!ticker) return;
  document.getElementById('boardTickerLabel').textContent = ticker;
  const staticMembers = BOARD_DATA[ticker];
  if (staticMembers) {
    document.getElementById('boardList').innerHTML=staticMembers.map(m=>`
      <div class="board-item">
        <div class="board-avatar">${m.initials}</div>
        <div class="board-info">
          <div class="board-name">${m.name} <span class="board-score">â˜… ${m.score}</span></div>
          <div class="board-role">${m.role}</div>
          <div class="board-bio">${m.bio}</div>
        </div>
      </div>`).join('');
  } else {
    document.getElementById('boardList').innerHTML='<div style="text-align:center;padding:12px;color:var(--text3)">YÃ¶netim verisi yÃ¼kleniyor...</div>';
    const executives = await fetchBoard(ticker);
    if (executives.length > 0) {
      document.getElementById('boardList').innerHTML=executives.slice(0,6).map(e=>`
        <div class="board-item">
          <div class="board-avatar">${(e.name||'?').split(' ').map(w=>w[0]).slice(0,2).join('')}</div>
          <div class="board-info">
            <div class="board-name">${e.name||'â€”'}</div>
            <div class="board-role">${e.title||'â€”'}</div>
            <div class="board-bio">YaÅŸ: ${e.age||'â€”'} ${e.totalCompensation?'Â· MaaÅŸ: $'+Math.round(e.totalCompensation/1000000)+'M':''}</div>
          </div>
        </div>`).join('');
    }
  }
  // Insider
  const insiders = await fetchInsider(ticker);
  if (insiders.length > 0) {
    document.getElementById('insiderList').innerHTML=insiders.map(t=>{
      const isBuy=(t.transactionType||'').toLowerCase().includes('buy')||(t.change||0)>0;
      return `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
        <div><div style="font-size:12px;font-weight:600">${t.name||'â€”'}</div><div style="font-size:10px;color:var(--text3)">${t.transactionDate||''} Â· ${t.transactionType||''}</div></div>
        <div style="text-align:right"><div style="font-size:12px;color:${isBuy?'var(--green)':'var(--red)'}">${isBuy?'+':''}${(t.change||0).toLocaleString()} hisse</div></div>
      </div>`;
    }).join('');
  } else {
    document.getElementById('insiderList').innerHTML=`
      <div class="unusual-item"><div class="unusual-header"><div class="unusual-ticker">Ä°Ã§eriden AlÄ±m</div><div class="unusual-size up">$2.1M</div></div><div class="unusual-detail">CFO Â· 10,500 hisse Â· $198.40 Â· Form 4</div><div style="font-size:10px;color:var(--green);margin-top:3px">â–² Bullish Sinyal</div></div>
      <div class="unusual-item"><div class="unusual-header"><div class="unusual-ticker">Ä°Ã§eriden SatÄ±ÅŸ</div><div class="unusual-size down">$890K</div></div><div class="unusual-detail">Board Member Â· 4,200 hisse Â· $212.00</div><div style="font-size:10px;color:var(--text3);margin-top:3px">â— PlanlÄ± satÄ±ÅŸ (10b5-1)</div></div>`;
  }
}

// FIX: Single renderValuation (was duplicated; async API-first version)
async function renderValuation(ticker) {
  if (!ticker) return;
  document.getElementById('valTickerLabel').textContent = ticker;
  let fin = await fetchFinancials(ticker);
  const staticV = VALUATION_DATA[ticker];

  const assess=(val,low,high)=>!val?{label:'N/A',color:'var(--text2)'}:val<low?{label:'UCUZ',color:'var(--green)'}:val>high?{label:'PAHALI',color:'var(--red)'}:{label:'Adil',color:'var(--warn)'};
  const fmt=(v,suf='x')=>v!=null?v.toFixed(1)+suf:'N/A';

  let metrics;
  if (fin) {
    metrics=[
      {label:'P/E',val:fmt(fin.pe),...assess(fin.pe,15,30)},
      {label:'P/B',val:fmt(fin.pb),...assess(fin.pb,1,5)},
      {label:'EV/EBITDA',val:fmt(fin.evEbitda),...assess(fin.evEbitda,8,20)},
      {label:'P/S',val:fmt(fin.ps),...assess(fin.ps,2,8)},
      {label:'BrÃ¼t Marj',val:fmt(fin.grossMargin,'%'),color:fin.grossMargin>50?'var(--green)':fin.grossMargin>20?'var(--warn)':'var(--red)',label2:''},
      {label:'Net Marj',val:fmt(fin.netMargin,'%'),color:fin.netMargin>15?'var(--green)':fin.netMargin>5?'var(--warn)':'var(--red)',label2:''},
      {label:'Beta',val:fin.beta?.toFixed(2)||'N/A',color:'var(--text)'},
      {label:'52H YÃ¼ksek',val:fin.high52w?'$'+fin.high52w.toFixed(2):'N/A',color:'var(--text)'},
    ];
  } else if (staticV) {
    metrics=[
      {label:'P/E',...assess(staticV.pe,15,25),val:staticV.pe+'x'},
      {label:'P/B',...assess(staticV.pb,1,3),val:staticV.pb+'x'},
      {label:'EV/EBITDA',...assess(staticV.evEbitda,8,15),val:staticV.evEbitda+'x'},
      {label:'PEG',...assess(staticV.peg,0.5,1.5),val:staticV.peg+'x'},
      {label:'P/FCF',...assess(staticV.pfcf,15,30),val:staticV.pfcf?staticV.pfcf+'x':'N/A'},
      {label:'EV/EBIT',...assess(staticV.evEbit,10,20),val:staticV.evEbit+'x'},
    ];
  } else {
    metrics=[{label:'Veri yok',val:'â€”',color:'var(--text3)'}];
  }

  document.getElementById('valuationGrid').innerHTML=metrics.map(m=>`
    <div class="val-item">
      <div class="val-label">${m.label}</div>
      <div class="val-value" style="color:${m.color||'var(--text)'}">${m.val}</div>
      ${m.label2!==undefined?'':m.label?`<div class="val-status" style="color:${m.color||'var(--text2)'}">â— ${m.label}</div>`:''}
    </div>`).join('');
}

function renderMicroCap() {
  document.getElementById('microcapList').innerHTML=MICROCAP_STOCKS.map(m=>`
    <div class="opp-card" style="border-color:rgba(255,100,50,0.3)">
      <div class="opp-header">
        <div>
          <div style="display:flex;align-items:center">
            <div class="opp-ticker" style="color:#ff6032">${m.ticker}</div>
            <span class="micro-badge">MicroCap</span>
          </div>
          <div style="font-size:10px;color:var(--text3)">${m.name} Â· Piyasa: ${m.mc}</div>
          <div style="font-size:9px;color:var(--text3);margin-top:2px">${m.sector}</div>
        </div>
        <div style="text-align:right">
          <div class="opp-upside">${m.pct}</div>
          <div style="font-size:9px;margin-top:3px">
            <span style="font-family:'Space Mono';color:var(--accent)">${m.score}/100</span>
          </div>
        </div>
      </div>
      <div class="opp-reason">${m.reason}</div>
      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
        <span class="unusual-type ${m.risk.includes('YÃœKSEK')||m.risk==='EKSTREm'?'put-type':'call-type'}">Risk: ${m.risk}</span>
        <div style="font-size:9px;color:var(--text3)">GÃ¼ven: <span style="color:var(--accent);font-family:'Space Mono'">${m.score}%</span></div>
      </div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runAIAnalysis(type, ticker) {
  const elId = type==='stock'?'aiAnalysisText':type==='geo'?'geopoliticalSummary':type==='valuation'?'valuationAI':'microcapAI';
  const el = document.getElementById(elId);
  el.innerHTML='<div style="display:flex;gap:4px;align-items:center"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div>&nbsp; Analiz yapÄ±lÄ±yor...</div>';

  const s = ticker ? getStockData(ticker) : null;
  const prices = ticker ? (candleCache[ticker]?.prices || generatePrices(ticker)) : null;
  const rsi = prices ? calcRSI(prices) : 50;
  const macd = prices ? calcMACD(prices) : 0;
  const ichi = prices ? calcIchimoku(prices) : null;
  const elliott = prices ? detectElliott(prices) : null;
  const v = ticker ? VALUATION_DATA[ticker] : null;

  let prompt='';
  if (type==='stock' && ticker) {
    prompt=`Sen uzman bir finansal analistsin ve TÃ¼rkÃ§e konuÅŸuyorsun. ${ticker} hissesini analiz et.
Veriler: Fiyat $${s.price.toFixed(2)}, GÃ¼nlÃ¼k deÄŸiÅŸim: ${s.changePct.toFixed(2)}%, SektÃ¶r: ${s.sector}
Teknik: RSI=${rsi}, MACD=${macd}, Stoch=${calcStoch(prices)}%, CCI=${calcCCI(prices)}
Ichimoku: ${ichi?`Fiyat bulutun ${ichi.aboveCloud?'Ã¼zerinde':ichi.belowCloud?'altÄ±nda':'iÃ§inde'}, Tenkan=${ichi.tenkan}, Kijun=${ichi.kijun}`:'Veri yok'}
Elliott Wave: ${elliott?`${elliott.wave} dalgasÄ±, ${elliott.trend} trend, ${elliott.phase}`:'Analiz edilemedi'}
Fibonacci: %61.8 destek seviyesini belirt.
3-4 cÃ¼mle, net analiz yap. Son cÃ¼mlede AL/SAT/BEKLE Ã¶nerisini belirt ve gerekÃ§eni yaz.`;
  } else if (type==='geo') {
    prompt=`Sen kÃ¼resel finans ve jeopolitik uzmanÄ±sÄ±n. TÃ¼rkÃ§e konuÅŸ. BugÃ¼nÃ¼n piyasalarÄ±nÄ± etkileyen en kritik 3 faktÃ¶rÃ¼ anlat: Fed politikasÄ±, jeopolitik riskler (Ã‡in-BatÄ±, Orta DoÄŸu), teknoloji dÃ¼zenlemeleri. Hangi sektÃ¶rler risk altÄ±nda, hangilerinde fÄ±rsat var? 3-4 cÃ¼mle, net ve somut Ã¶neriler.`;
  } else if (type==='valuation' && ticker) {
    const peVal=v?v.pe:25, pbVal=v?v.pb:4, evVal=v?v.evEbitda:18;
    prompt=`Sen deÄŸerleme uzmanÄ± bir analistsin. TÃ¼rkÃ§e konuÅŸ. ${ticker} hissesini deÄŸerle: P/E=${peVal}x, P/B=${pbVal}x, EV/EBITDA=${evVal}x. SektÃ¶r ortalamalarÄ± ile karÅŸÄ±laÅŸtÄ±r, ucuz mu pahalÄ± mÄ±? 3-4 cÃ¼mle. Net bir deÄŸerleme kararÄ± ver.`;
  } else if (type==='microcap') {
    prompt=`Sen mikro-cap hisse uzmanÄ±sÄ±n. TÃ¼rkÃ§e konuÅŸ. Piyasa deÄŸeri $50M-$300M arasÄ±, yÃ¼ksek bÃ¼yÃ¼me potansiyeli olan ABD micro-cap hisselerini analiz et. 2025'te en Ã§ok patlama potansiyeli olan 3 sektÃ¶rÃ¼ belirt (AI/robotik, biyoteknoloji, uzay teknolojisi gibi). YatÄ±rÄ±mcÄ±nÄ±n dikkat etmesi gereken risk faktÃ¶rlerini de say. 4-5 cÃ¼mle.`;
  }

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:600,
        messages:[{role:'user',content:prompt}]
      })
    });
    const data = await res.json();
    const text = data.content?.[0]?.text || 'Analiz tamamlanamadÄ±.';
    el.textContent=text;
  } catch(e) {
    const demos={
      stock:`${ticker} iÃ§in teknik analiz: RSI=${rsi} ${rsi<40?'aÅŸÄ±rÄ± satÄ±m bÃ¶lgesinde alÄ±m fÄ±rsatÄ± sunuyor':'nÃ¶tr bÃ¶lgede seyrediyor'}. MACD ${macd>0?'pozitif momentum':'negatif momentum'} gÃ¶steriyor. Ichimoku ${ichi&&ichi.aboveCloud?'bullish':'nÃ¶tr/bearish'} sinyal veriyor. Genel gÃ¶rÃ¼nÃ¼m: ${rsi<40&&macd>0?'AL':'BEKLE'}.`,
      geo:'KÃ¼resel piyasalarda Fed faiz politikasÄ± belirleyici olmayÄ± sÃ¼rdÃ¼rÃ¼yor. Ã‡in-BatÄ± gerilimi yarÄ± iletken sektÃ¶rÃ¼nÃ¼ baskÄ± altÄ±nda tutuyor. AI altyapÄ±sÄ± ve savunma sektÃ¶rleri fÄ±rsat sunuyor.',
      valuation:`${ticker} deÄŸerleme analizi iÃ§in API baÄŸlantÄ±sÄ± gerekiyor. Mevcut statik verilere gÃ¶re ${v&&v.pe<20?'ucuz':'adil/pahalÄ±'} bÃ¶lgede.`,
      microcap:'MicroCap analizi: AI altyapÄ±sÄ± (BBAI, SoundHound), uzay teknolojisi (RKLB, AST), ve biyoteknoloji sektÃ¶rleri 2025\'te yÃ¼ksek potansiyel sunuyor. Risk yÃ¶netimi iÃ§in pozisyon bÃ¼yÃ¼klÃ¼ÄŸÃ¼nÃ¼ sÄ±nÄ±rlayÄ±n.'
    };
    el.textContent=demos[type]||'AI analizi iÃ§in baÄŸlantÄ± saÄŸlanamadÄ±.';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(view) {
  currentView=view;
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+view).classList.add('active');
  document.querySelectorAll('.tab,.bnav-item').forEach(t=>t.classList.toggle('active',t.dataset.view===view));
  refreshCurrentView();
}

function refreshCurrentView() {
  if(currentView==='watchlist'){renderWatchlist();if(selectedTicker)renderMiniChart(selectedTicker);}
  else if(currentView==='signal')renderSignal(selectedTicker);
  else if(currentView==='opportunities')renderOpportunities();
  else if(currentView==='unusual')renderUnusual();
  else if(currentView==='news')renderNews();
  else if(currentView==='board')renderBoard(selectedTicker);
  else if(currentView==='valuation')renderValuation(selectedTicker);
  else if(currentView==='microcap')renderMicroCap();
}

function selectTicker(ticker) {
  selectedTicker=ticker;
  renderWatchlist();
  renderMiniChart(ticker);
  if(currentView==='signal')renderSignal(ticker);
  else if(currentView==='board')renderBoard(ticker);
  else if(currentView==='valuation')renderValuation(ticker);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LOCAL_DB=[
  {s:'AAPL',n:'Apple Inc.',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},{s:'MSFT',n:'Microsoft Corporation',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'GOOGL',n:'Alphabet Inc.',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},{s:'AMZN',n:'Amazon.com Inc.',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'NVDA',n:'NVIDIA Corporation',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},{s:'META',n:'Meta Platforms Inc.',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'TSLA',n:'Tesla Inc.',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},{s:'PLTR',n:'Palantir Technologies Inc.',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},
  {s:'ARM',n:'Arm Holdings plc',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},{s:'AVGO',n:'Broadcom Inc.',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'ORCL',n:'Oracle Corporation',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'AMD',n:'Advanced Micro Devices',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'INTC',n:'Intel Corporation',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},{s:'QCOM',n:'Qualcomm Inc.',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'JPM',n:'JPMorgan Chase & Co.',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'BAC',n:'Bank of America',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},
  {s:'GS',n:'Goldman Sachs Group',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'MS',n:'Morgan Stanley',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},
  {s:'V',n:'Visa Inc.',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'MA',n:'Mastercard Inc.',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},
  {s:'WMT',n:'Walmart Inc.',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'COST',n:'Costco Wholesale',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'JNJ',n:'Johnson & Johnson',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'UNH',n:'UnitedHealth Group',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},
  {s:'LLY',n:'Eli Lilly and Company',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'XOM',n:'Exxon Mobil',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},
  {s:'NFLX',n:'Netflix Inc.',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},{s:'DIS',n:'Walt Disney Company',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},
  {s:'UBER',n:'Uber Technologies',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'COIN',n:'Coinbase Global',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'SMCI',n:'Super Micro Computer',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},{s:'IONQ',n:'IonQ Inc.',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},
  {s:'RKLB',n:'Rocket Lab USA',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},{s:'BBAI',n:'BigBear.ai Holdings',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},
  {s:'NET',n:'Cloudflare Inc.',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'CRWD',n:'CrowdStrike Holdings',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'SPY',n:'SPDR S&P 500 ETF',e:'NYSE',t:'ğŸ‡ºğŸ‡¸'},{s:'QQQ',n:'Invesco QQQ Trust',e:'NASDAQ',t:'ğŸ‡ºğŸ‡¸'},
  {s:'BABA',n:'Alibaba Group',e:'NYSE',t:'ğŸ‡¨ğŸ‡³'},{s:'BIDU',n:'Baidu Inc.',e:'NASDAQ',t:'ğŸ‡¨ğŸ‡³'},
  {s:'NIO',n:'NIO Inc.',e:'NYSE',t:'ğŸ‡¨ğŸ‡³'},{s:'TCEHY',n:'Tencent Holdings',e:'OTC',t:'ğŸ‡¨ğŸ‡³'},
  {s:'SONY',n:'Sony Group Corporation',e:'NYSE',t:'ğŸ‡¯ğŸ‡µ'},{s:'TM',n:'Toyota Motor',e:'NYSE',t:'ğŸ‡¯ğŸ‡µ'},
  {s:'SAP',n:'SAP SE',e:'NYSE',t:'ğŸ‡©ğŸ‡ª'},{s:'AZN',n:'AstraZeneca PLC',e:'NASDAQ',t:'ğŸ‡¬ğŸ‡§'},
  {s:'ASML',n:'ASML Holding N.V.',e:'NASDAQ',t:'ğŸ‡³ğŸ‡±'},{s:'INFY',n:'Infosys Ltd.',e:'NYSE',t:'ğŸ‡®ğŸ‡³'},
  {s:'THYAO.IS',n:'TÃ¼rk Hava YollarÄ±',e:'BIST',t:'ğŸ‡¹ğŸ‡·'},{s:'GARAN.IS',n:'Garanti BBVA',e:'BIST',t:'ğŸ‡¹ğŸ‡·'},
  {s:'KCHOL.IS',n:'KoÃ§ Holding',e:'BIST',t:'ğŸ‡¹ğŸ‡·'},{s:'EREGL.IS',n:'EreÄŸli Demir Ã‡elik',e:'BIST',t:'ğŸ‡¹ğŸ‡·'},
  {s:'BIMAS.IS',n:'BÄ°M BirleÅŸik MaÄŸazalar',e:'BIST',t:'ğŸ‡¹ğŸ‡·'},{s:'AKBNK.IS',n:'Akbank T.A.Å.',e:'BIST',t:'ğŸ‡¹ğŸ‡·'},
];

let activeExchFilter='ALL', searchCache={}, searchTimer=null;

function localSearch(q) {
  const ql=q.toLowerCase().trim(); if(!ql) return [];
  return LOCAL_DB.filter(item=>{
    const mt=item.s.toLowerCase().includes(ql);
    const mn=item.n.toLowerCase().includes(ql);
    const me=activeExchFilter==='ALL'||item.e.includes(activeExchFilter)||item.t.includes(activeExchFilter.slice(0,2));
    return (mt||mn)&&me;
  }).sort((a,b)=>(a.s.toLowerCase().startsWith(ql)?0:1)-(b.s.toLowerCase().startsWith(ql)?0:1)).slice(0,25);
}

async function finnhubSearch(q) {
  const key=q+activeExchFilter; if(searchCache[key]) return searchCache[key];
  try {
    const res=await fetch(`https://finnhub.io/api/v1/search?q=${encodeURIComponent(q)}&token=${FINNHUB_KEY}`);
    const data=await res.json();
    if(data.result){const r=data.result.map(x=>({s:x.symbol,n:x.description,e:x.displaySymbol||'',t:'ğŸŒ'})).slice(0,15);searchCache[key]=r;return r;}
  }catch(e){}
  return [];
}

function renderSearchResults(results, q) {
  const el=document.getElementById('searchResults');
  const pop=document.getElementById('popularSection');
  if(!q){el.innerHTML='';pop.style.display='block';return;}
  pop.style.display='none';
  if(!results.length){el.innerHTML=`<div style="text-align:center;padding:24px;color:var(--text3)">ğŸ” "${q}" iÃ§in sonuÃ§ bulunamadÄ±</div>`;return;}
  const hi=(txt,q)=>{const i=txt.toLowerCase().indexOf(q.toLowerCase());return i<0?txt:txt.slice(0,i)+`<span style="color:var(--accent);font-weight:700">${txt.slice(i,i+q.length)}</span>`+txt.slice(i+q.length);};
  el.innerHTML=results.map(r=>{
    const inList=watchlist.includes(r.s);
    return `<div class="search-result-item">
      <div class="sri-left">
        <div class="sri-flag">${r.t||'ğŸŒ'}</div>
        <div class="sri-info">
          <div class="sri-ticker">${hi(r.s,q)}</div>
          <div class="sri-name">${hi(r.n,q)}</div>
          <div class="sri-exchange">${r.e}</div>
        </div>
      </div>
      <div><div class="sri-add-btn ${inList?'added':''}" id="addbtn-${r.s.replace(/[^a-zA-Z0-9]/g,'_')}" onclick="toggleFromSearch('${r.s}','${r.n.replace(/'/g,"\\'")}')">
        ${inList?'âœ“ Listede':'+ Ekle'}
      </div></div>
    </div>`;
  }).join('');
}

function toggleFromSearch(ticker, name) {
  if(watchlist.includes(ticker)){watchlist=watchlist.filter(t=>t!==ticker);}
  else{if(!LOCAL_DB.find(d=>d.s===ticker))LOCAL_DB.push({s:ticker,n:name||ticker,e:'Global',t:'ğŸŒ'});watchlist.push(ticker);selectedTicker=ticker;}
  saveWatchlist(); renderWatchlist(); renderWatchlistManage();
  const btn=document.getElementById('addbtn-'+ticker.replace(/[^a-zA-Z0-9]/g,'_'));
  if(btn){const inList=watchlist.includes(ticker);btn.textContent=inList?'âœ“ Listede':'+ Ekle';btn.className='sri-add-btn'+(inList?' added':'');}
}

function renderWatchlistManage() {
  document.getElementById('watchlistManage').innerHTML=watchlist.map(t=>`
    <div class="wl-chip">
      <span onclick="selectAndClose('${t}')">${t}</span>
      <span class="remove" onclick="removeFromWatchlist('${t}')">Ã—</span>
    </div>`).join('');
}

function removeFromWatchlist(ticker) {
  watchlist=watchlist.filter(t=>t!==ticker);
  if(selectedTicker===ticker)selectedTicker=watchlist[0]||'';
  saveWatchlist(); renderWatchlist(); renderWatchlistManage();
  const q=document.getElementById('stockInput').value.trim();
  if(q) renderSearchResults(localSearch(q),q);
}

function selectAndClose(ticker) {
  selectedTicker=ticker; closeModal(); refreshCurrentView();
}

function openModal() {
  document.getElementById('modalOverlay').classList.add('open');
  renderWatchlistManage();
  document.getElementById('quickAdd').innerHTML=QUICK_TICKERS.filter(t=>!watchlist.includes(t)).map(t=>{
    const info=LOCAL_DB.find(d=>d.s===t);
    return `<div onclick="toggleFromSearch('${t}','${info?info.n:t}')" style="padding:5px 12px;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-radius:20px;font-family:'Space Mono',monospace;font-size:10px;color:var(--accent);cursor:pointer">${info?info.t:''} ${t}</div>`;
  }).join('');
  setTimeout(()=>document.getElementById('stockInput').focus(),300);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  document.getElementById('stockInput').value='';
  document.getElementById('searchResults').innerHTML='';
  document.getElementById('popularSection').style.display='block';
}

document.getElementById('stockInput').addEventListener('input',function(){
  const q=this.value.trim(); clearTimeout(searchTimer);
  if(!q){renderSearchResults([],'');return;}
  renderSearchResults(localSearch(q),q);
  if(q.length>=2){
    document.getElementById('searchSpinner').style.display='block';
    searchTimer=setTimeout(async()=>{
      const api=await finnhubSearch(q);
      const loc=localSearch(q);
      const merged=[...loc];
      api.forEach(r=>{if(!merged.find(l=>l.s===r.s))merged.push(r);});
      renderSearchResults(merged.slice(0,30),q);
      document.getElementById('searchSpinner').style.display='none';
    },400);
  }
});

document.getElementById('exchangeFilter').addEventListener('click',e=>{
  const btn=e.target.closest('.exch-btn'); if(!btn) return;
  document.querySelectorAll('.exch-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); activeExchFilter=btn.dataset.exch;
  const q=document.getElementById('stockInput').value.trim();
  if(q) renderSearchResults(localSearch(q),q);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK & AUTO-REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setInterval(()=>{document.getElementById('clock').textContent=new Date().toLocaleTimeString('tr-TR');},1000);
document.getElementById('clock').textContent=new Date().toLocaleTimeString('tr-TR');

setInterval(async()=>{
  await Promise.all(watchlist.map(t=>fetchQuote(t)));
  if(currentView==='watchlist') renderWatchlist();
},15000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENT LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.tab,.bnav-item').forEach(t=>t.addEventListener('click',()=>switchView(t.dataset.view)));
document.getElementById('addStockBtn').addEventListener('click',openModal);
document.getElementById('modalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal();});
document.getElementById('stockInput').addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});
document.getElementById('analyzeBtn').addEventListener('click',()=>runAIAnalysis('stock',selectedTicker));
document.getElementById('geoAnalyzeBtn').addEventListener('click',()=>runAIAnalysis('geo',null));
document.getElementById('boardAnalyzeBtn').addEventListener('click',()=>runAIAnalysis('stock',selectedTicker));
document.getElementById('valuationBtn').addEventListener('click',()=>runAIAnalysis('valuation',selectedTicker));
document.getElementById('scanBtn').addEventListener('click',renderOpportunities);
document.getElementById('microcapBtn').addEventListener('click',()=>runAIAnalysis('microcap',null));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async()=>{
  renderWatchlist();
  await Promise.all(watchlist.map(t=>fetchQuote(t)));
  renderWatchlist();
  if(selectedTicker){
    await fetchProfile(selectedTicker);
    renderMiniChart(selectedTicker);
  }
})();
</script>
</body>
</html>
